<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox Map for Tilda</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: Roboto, 'Segoe UI', Tahoma, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        #header {
            position: absolute;
            text-align: center;
            font-size: 18px;
            color: #f6fff7;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgb(0,65,35);
            background: linear-gradient(90deg, rgba(0,65,35,1) 0%, rgba(0,142,99,1) 20%, rgba(0,142,99,1) 80%, rgba(0,65,35,1) 100%);
            width: 100%;
            height: 40px;
            left: 0px;
            top: 0px;
            z-index: 10;
        }
        #footer {
            position: absolute;
            text-indent: 10px;
            color: #f6fff7;
            font-size: 12px;
            background: rgba(0,142,99);
            width: 100%;
            height: 20px;
            left: 0px;
            bottom: 0px;
            z-index: 10;
        }
        .rounded-rect {
            background: #f6fff7;
            border-radius: 10px;
            box-shadow: 0 0 50px -25px black;
        }
        .flex-center {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .flex-center.left {
            left: 0px;
        }
        .sidebar-content {
            position: absolute;
            width: 95%;
            height: 80%;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 32px;
            color: gray;
        }
        .sidebar-toggle {
            position: absolute;
            width: 1.3em;
            height: 1.3em;
            overflow: visible;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .sidebar-toggle.left {
            right: -1.5em;
        }
        .sidebar-toggle:hover {
            color: #0aa1cf;
            cursor: pointer;
        }
        .sidebar {
            transition: transform 1s;
            z-index: 1;
            width: 300px;
            height: 100%;
        }
        .left.collapsed {
            transform: translateX(-295px);
        }
        .mapboxgl-popup-content {
            color: black;
            max-width: 240px;
            font-family: Roboto, 'Segoe UI', Tahoma, sans-serif;
            font-size: 12px;
            text-align: center;
        }
        .mapboxgl-popup-content p {
            text-align: left;
        }
        #legend {
            padding: 0 10px 0 0px;
            width: 260px;
            top: 14px;
            position: absolute;
            justify-content: start;
            z-index: 1;
            max-height: calc(100% - 100px);
            overflow-y: auto;
        }
        .legend h4 {
            margin: 0 0 10px;
        }
        .legend div span {
            border-radius: 50%;
            display: inline-block;
            height: 10px;
            margin-right: 5px;
            width: 10px;
        }
        .mapboxgl-legend-list {
            overflow-y: auto;
            max-height: calc(137% * 0.7);
            text-align: center;
        }
        .legend-table {
            float: left;
        }
        .legend-table-td {
            font-family: Roboto, 'Segoe UI', Tahoma, sans-serif;
            font-size: 14px;
        }
        .legend-table-title {
            font-family: Roboto, 'Segoe UI', Tahoma, sans-serif;
            font-weight: 500;
            font-size: 16px;
        }
        .legend-table-title2 {
            color: #f6fff7;
        }
        .mapboxgl-legend-title-label {
            color: black;
            font-family: Roboto, 'Segoe UI', Tahoma, sans-serif;
            font-size: 18px;
        }
        table td:nth-of-type(1) {
            width: 20px;
        }
        table td:nth-of-type(2) {
            text-align: center;
            width: 70px;
        }
        table td:nth-of-type(3) {
            width: 170px;
        }
        td.legend-table-td, th.legend-table-th {
            border: 0px solid #000;
            border-collapse: collapse;
            margin: 10px;
            padding: 2px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="header">Туристская карта</div>
    <div id="footer">Интерактивная карта</div>
    <div id="map">
        <div id="left" class="sidebar flex-center left collapsed">
            <div class="sidebar-content rounded-rect flex-center">
                <div id="legend" class="mapboxgl-legend-list" style="display: block;">
                    <label class="mapboxgl-legend-title-label">УСЛОВНЫЕ ОБОЗНАЧЕНИЯ</label>
                    <table class="legend-table">
                        <tr>
                            <th class="legend-table-td" colspan="3">
                                <label class="legend-table-title2">_____________________________________</label>
                            </th>
                        </tr>
                        <tr>
                            <th class="legend-table-td" colspan="3">
                                <label class="legend-table-title">Историко-культурные объекты</label>
                            </th>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="castle" type="checkbox" name="points-6l41lp" value="points-6l41lp" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#996633" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M9,4 L12,4 L11,3 L12,2 L9,2 L9,4 Z M7,6 L11,6 L10,9 L11,9 L11,10 L9,10 L9,9 L7,9 L7,10 L5,10 L5,9 L6,9 L5,6 L7,6 Z M5,11 L5,14 L7,14 L7,13 C7,12 8,11 9,11 C10,11 11,12 11,13 L11,14 L13,14 L13,11 L5,11 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Замки</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="fort" type="checkbox" name="fort-899e2a" value="fort-899e2a" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#996633" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M9,5 L12,5 L11,4 L12,3 L9,3 L9,5 Z M9,7 L9,8 L7,8 L7,7 L6,7 L5,10 L6,10 L6,11 L5,11 L5,12 L7,12 L7,13 L5,13 L5,14 L13,14 L13,13 L11,13 L11,12 L13,12 L13,11 L12,11 L12,10 L13,10 L12,7 L11,7 L11,8 L9,8 L9,7 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Фортификационные сооружения</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="church" type="checkbox" name="points-6l41lp-church" value="points-6l41lp-church" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#996633" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M9,3 L9,5 L7,5 L7,6 L9,6 L9,14 L11,14 L11,6 L13,6 L13,5 L11,5 L11,3 L9,3 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Храмы, соборы, кирхи</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="museum" type="checkbox" name="points-6l41lp-museum" value="points-6l41lp-museum" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#996633" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M9,4 L13,6 L13,7 L4,7 L4,6 L9,4 Z M5,8 L5,11 L7,11 L7,8 L5,8 Z M8,8 L8,11 L10,11 L10,8 L8,8 Z M11,8 L11,11 L13,11 L13,8 L11,8 Z M4,12 L14,12 L14,13 L4,13 L4,12 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Музеи</label>
                            </td>
                        </tr>
                        <tr>
                            <th class="legend-table-td" colspan="3">
                                <label class="legend-table-title2">_____________________________________</label>
                            </th>
                        </tr>
                        <tr>
                            <th class="legend-table-td" colspan="3">
                                <label class="legend-table-title">Природные объекты</label>
                            </th>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="park" type="checkbox" name="points-6l41lp-park" value="points-6l41lp-park" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#339966" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M9,4 C6.2,4 4,6.2 4,9 C4,11.8 6.2,14 9,14 C11.8,14 14,11.8 14,9 C14,6.2 11.8,4 9,4 Z M9,6 C10.7,6 12,7.3 12,9 C12,10.7 10.7,12 9,12 C7.3,12 6,10.7 6,9 C6,7.3 7.3,6 9,6 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Парки</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="beach" type="checkbox" name="points-6l41lp-beach" value="points-6l41lp-beach" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#339966" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M5,9 C5,7.3 6.3,6 8,6 L8,8 C7.4,8 7,8.4 7,9 L5,9 Z M9,6 C10.7,6 12,7.3 12,9 L10,9 C10,8.4 9.6,8 9,8 L9,6 Z M13,10 L4,10 L4,12 L13,12 L13,10 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Пляжи</label>
                            </td>
                        </tr>
                        <tr>
                            <th class="legend-table-td" colspan="3">
                                <label class="legend-table-title2">_____________________________________</label>
                            </th>
                        </tr>
                        <tr>
                            <th class="legend-table-td" colspan="3">
                                <label class="legend-table-title">Туристическая инфраструктура</label>
                            </th>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="hotel" type="checkbox" name="points-6l41lp-hotel" value="points-6l41lp-hotel" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#3366cc" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M5,7 L5,13 L7,13 L7,11 L11,11 L11,13 L13,13 L13,7 L5,7 Z M6,8 L8,8 L8,10 L6,10 L6,8 Z M10,8 L12,8 L12,10 L10,10 L10,8 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Отели</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="cafe" type="checkbox" name="points-6l41lp-cafe" value="points-6l41lp-cafe" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#3366cc" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M6,5 L12,5 C13.1,5 14,5.9 14,7 L14,8 C14,9.1 13.1,10 12,10 L6,10 L6,13 L4,13 L4,5 L6,5 Z M6,7 L6,8 L12,8 L12,7 L6,7 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Кафе и рестораны</label>
                            </td>
                        </tr>
                        <tr>
                            <td class="legend-table-td">
                                <input id="info" type="checkbox" name="points-6l41lp-info" value="points-6l41lp-info" checked>
                            </td>
                            <td class="legend-table-td">
                                <svg width="18" height="18" viewBox="0 0 18 18">
                                    <circle fill="#3366cc" stroke="#FFFFFF" stroke-width="1" cx="9" cy="9" r="8"/>
                                    <path fill="#FFFFFF" d="M9,4 C6.2,4 4,6.2 4,9 C4,11.8 6.2,14 9,14 C11.8,14 14,11.8 14,9 C14,6.2 11.8,4 9,4 Z M9,6 C9.6,6 10,6.4 10,7 C10,7.6 9.6,8 9,8 C8.4,8 8,7.6 8,7 C8,6.4 8.4,6 9,6 Z M8,9 L10,9 L10,12 L8,12 L8,9 Z"/>
                                </svg>
                            </td>
                            <td class="legend-table-td">
                                <label>Информационные центры</label>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="sidebar-toggle left" onclick="toggleSidebar('left')">❯</div>
            </div>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    
    <script>
        // Parse URL parameters to get configuration
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token') || 'YOUR_MAPBOX_ACCESS_TOKEN';
        const styleUrl = urlParams.get('style') || 'mapbox://styles/miigaik/cmb6asiwu00oc01s9ea9fag9w';
        const centerLng = parseFloat(urlParams.get('lng') || '21.25');
        const centerLat = parseFloat(urlParams.get('lat') || '54.8');
        const zoomLevel = parseFloat(urlParams.get('zoom') || '7.7');
        const minZoom = parseFloat(urlParams.get('minZoom') || '7.7');
        const maxZoom = parseFloat(urlParams.get('maxZoom') || '15.5');
        const bearing = parseFloat(urlParams.get('bearing') || '0');
        const pitch = parseFloat(urlParams.get('pitch') || '0');
        const headerText = urlParams.get('header') || 'Туристская карта';
        const footerText = urlParams.get('footer') || 'Интерактивная карта';
        
        // Set header and footer text
        document.getElementById('header').textContent = headerText;
        document.getElementById('footer').textContent = footerText;
        
        // Initialize the map
        mapboxgl.accessToken = accessToken;
        const map = new mapboxgl.Map({
            container: 'map',
            style: styleUrl,
            center: [centerLng, centerLat],
            zoom: zoomLevel,
            minZoom: minZoom,
            maxZoom: maxZoom,
            bearing: bearing,
            pitch: pitch
        });
        
        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.FullscreenControl());
        map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');
        
        // Toggle sidebar function
        function toggleSidebar(id) {
            const elem = document.getElementById(id);
            const collapsed = elem.classList.toggle('collapsed');
            const padding = {};
            padding[id] = collapsed ? 0 : 300;
            map.easeTo({
                padding: padding,
                duration: 1000
            });
        }
        
        // Setup layer visibility toggle handlers
        function setupLayerToggle(checkboxId, layerId) {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    if (map.getLayer(layerId)) {
                        map.setLayoutProperty(
                            layerId,
                            'visibility',
                            checkbox.checked ? 'visible' : 'none'
                        );
                    }
                    
                    // Send message to parent about layer toggle
                    if (window.parent) {
                        window.parent.postMessage({
                            type: 'layerToggle',
                            layerId: layerId,
                            visible: checkbox.checked
                        }, '*');
                    }
                });
            }
        }
        
        // Setup popup functionality
        map.on('click', (event) => {
            // Define the layers to query for features
            const layers = [
                'points-6l41lp', 'fort-899e2a', 'points-6l41lp-church', 
                'points-6l41lp-museum', 'points-6l41lp-park', 'points-6l41lp-beach',
                'points-6l41lp-hotel', 'points-6l41lp-cafe', 'points-6l41lp-info'
            ];
            
            // Query features at the clicked point
            const features = map.queryRenderedFeatures(event.point, {
                layers: layers
            });
            
            // If no features found, return
            if (!features.length) {
                return;
            }
            
            // Get the first feature
            const feature = features[0];
            
            // Create popup content
            let popupContent = `<h3>${feature.properties.name || feature.properties.full_name || 'Объект'}</h3>`;
            
            // Add image if available
            if (feature.properties.img) {
                popupContent += `<p><img src="img/${feature.properties.img}.jpg" width="220" height="140"></p>`;
            }
            
            // Add description if available
            if (feature.properties.desc1 || feature.properties.description) {
                popupContent += `<p>${feature.properties.desc1 || feature.properties.description || ''}</p>`;
            }
            
            if (feature.properties.desc2) {
                popupContent += `<p>${feature.properties.desc2}</p>`;
            }
            
            // Create and add the popup
            new mapboxgl.Popup()
                .setLngLat(feature.geometry.coordinates)
                .setHTML(popupContent)
                .addTo(map);
                
            // Send message to parent about feature click
            if (window.parent) {
                window.parent.postMessage({
                    type: 'featureClick',
                    feature: {
                        id: feature.id,
                        properties: feature.properties,
                        coordinates: feature.geometry.coordinates
                    }
                }, '*');
            }
        });
        
        // Add pointer cursor when hovering over interactive layers
        function addPointerCursor(layerId) {
            map.on('mouseenter', layerId, () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            
            map.on('mouseleave', layerId, () => {
                map.getCanvas().style.cursor = '';
            });
        }
        
        // When the map is loaded
        map.on('load', () => {
            // Open the sidebar by default
            toggleSidebar('left');
            
            // Setup layer toggles
            setupLayerToggle('castle', 'points-6l41lp');
            setupLayerToggle('fort', 'fort-899e2a');
            setupLayerToggle('church', 'points-6l41lp-church');
            setupLayerToggle('museum', 'points-6l41lp-museum');
            setupLayerToggle('park', 'points-6l41lp-park');
            setupLayerToggle('beach', 'points-6l41lp-beach');
            setupLayerToggle('hotel', 'points-6l41lp-hotel');
            setupLayerToggle('cafe', 'points-6l41lp-cafe');
            setupLayerToggle('info', 'points-6l41lp-info');
            
            // Add pointer cursor for interactive layers
            addPointerCursor('points-6l41lp');
            addPointerCursor('fort-899e2a');
            addPointerCursor('points-6l41lp-church');
            addPointerCursor('points-6l41lp-museum');
            addPointerCursor('points-6l41lp-park');
            addPointerCursor('points-6l41lp-beach');
            addPointerCursor('points-6l41lp-hotel');
            addPointerCursor('points-6l41lp-cafe');
            addPointerCursor('points-6l41lp-info');
            
            // Notify parent when map is loaded
            if (window.parent) {
                window.parent.postMessage({
                    type: 'mapLoaded',
                    message: 'Mapbox map has loaded successfully'
                }, '*');
            }
        });
        
        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            // Make sure the message is from a trusted source
            // You can add more specific origin checks if needed
            
            const data = event.data;
            
            // Handle different message types
            if (data.type === 'flyTo') {
                map.flyTo({
                    center: [data.lng, data.lat],
                    zoom: data.zoom || zoomLevel,
                    bearing: data.bearing || bearing,
                    pitch: data.pitch || pitch,
                    essential: true
                });
            } else if (data.type === 'addMarker') {
                new mapboxgl.Marker()
                    .setLngLat([data.lng, data.lat])
                    .addTo(map);
            } else if (data.type === 'toggleLayer') {
                const checkbox = document.getElementById(data.layerId);
                if (checkbox) {
                    checkbox.checked = data.visible;
                    const event = new Event('change');
                    checkbox.dispatchEvent(event);
                }
            } else if (data.type === 'toggleSidebar') {
                toggleSidebar('left');
            }
        });
    </script>
</body>
</html>
